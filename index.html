<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Llama Catch-up</title>
    <script src="https://cdn.jsdelivr.net/npm/@streamerbot/client/dist/streamerbot-client.js"></script>
    <style>
        :root {
            --accent: #ff69b4;
            --sub: #9370db;
            --sub-bomb: #ffff00;
            --cheer: #00ffff;
            --bg: #0d0d12;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #bbbbbb;
            --text-muted: #777777;
            --debug-text: #5c5c66;
            --debug-border: #2a2a33;
            --drop-zone-border: rgba(255, 255, 255, 0.1);
            --drop-zone-text: rgba(255, 255, 255, 0.3);
            --drop-zone-active-bg: rgba(0, 255, 255, 0.05);
            --card-hover-bg: rgba(255, 255, 255, 0.08);
            --drag-preview-shadow: 0 12px 30px rgba(0, 0, 0, 0.45), 0 0 0 1px rgba(255, 255, 255, 0.12) inset;
            --sub-bomb-glow: rgba(255, 255, 0, 0.3);
            --cheer-glow: rgba(0, 255, 255, 0.3);
            --cheer-soft-bg: rgba(0, 255, 255, 0.1);
            --overlay-bg: rgba(0, 0, 0, 0.85);
            --modal-bg-start: rgba(13, 13, 18, 0.95);
            --modal-bg-end: rgba(20, 20, 30, 0.95);
            --modal-glow: rgba(147, 112, 219, 0.5);
            --panel-bg: rgba(255, 255, 255, 0.02);
            --input-bg: rgba(255, 255, 255, 0.05);
            --input-border: rgba(147, 112, 219, 0.4);
            --button-bg-start: rgba(147, 112, 219, 0.2);
            --button-bg-end: rgba(255, 105, 180, 0.2);
            --button-hover-start: rgba(147, 112, 219, 0.3);
            --button-hover-end: rgba(255, 105, 180, 0.3);
            --button-glow: rgba(147, 112, 219, 0.4);
            --focus-glow: rgba(255, 105, 180, 0.5);
            --tab-active-start: rgba(147, 112, 219, 0.35);
            --tab-active-end: rgba(255, 105, 180, 0.35);
            --tab-active-glow: rgba(255, 105, 180, 0.25);
            --text-inverse: #ffffff;
            --skip-btn-bg: #ff3b3b;
            --skip-btn-hover-bg: #ff0000;
            --card-padding: 10px;
            --color-scheme: dark;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text-primary);
            margin: 0;
            padding: 12px;
            overflow-x: hidden;
            user-select: none;
        }

        #header {
            text-align: center;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 8px;
            margin-bottom: 12px;
            position: sticky;
            top: 0;
            background: var(--bg);
            z-index: 10;
        }

        h1 {
            font-size: 0.9rem;
            letter-spacing: 2px;
            color: var(--accent);
            margin: 0;
            text-transform: uppercase;
        }

        #stats {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        #container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            min-height: 50px;
        }

        #drop-zone-bottom {
            height: 40px;
            border: 2px dashed var(--drop-zone-border);
            border-radius: 4px;
            display: none;
            align-items: center;
            justify-content: center;
            color: var(--drop-zone-text);
            font-size: 0.7rem;
            margin-top: 4px;
            transition: all 0.2s;
        }

        #drop-zone-bottom.visible {
            display: flex;
        }

        #drop-zone-bottom.drag-over {
            border-color: var(--cheer);
            background: rgba(0, 255, 255, 0.05);
            color: var(--cheer);
        }

        .card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-left: 4px solid var(--sub);
            padding: var(--card-padding);
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s, background 0.2s;
        }

        .card:hover {
            transform: translateX(4px);
            background: var(--card-hover-bg);
        }

        .card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .card.drag-over {
            border-top: 3px solid var(--cheer);
            transform: translateY(2px);
        }

        .drag-preview {
            opacity: 0.95;
            transform: rotate(1deg);
            box-shadow: var(--drag-preview-shadow);
        }

        /* Color Coding */
        .card.SubBomb { 
            border-left-color: var(--sub-bomb); 
            box-shadow: inset 5px 0 10px -5px rgba(255, 255, 0, 0.3);
        }

        .card.Cheer { 
            border-left-color: var(--cheer); 
            box-shadow: inset 5px 0 10px -5px rgba(0, 255, 255, 0.3);
        }

        .card.Sub { 
            border-left-color: var(--sub); 
        }

        .user {
            font-weight: 800;
            color: var(--text-primary);
            display: block;
            font-size: 1rem;
            margin-bottom: 2px;
        }

        .detail {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .time {
            font-size: 0.6rem;
            color: var(--accent);
            float: right;
        }

        .active-celebration {
            animation: pulse 0.8s infinite ease-in-out;
            border-color: var(--cheer);
            pointer-events: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.98); }
        }

        #debug-log {
            font-size: 0.6rem;
            color: var(--debug-text);
            margin-top: 20px;
            border-top: 1px dashed var(--debug-border);
            padding-top: 10px;
            font-family: monospace;
        }

        /* New state for when the card is clicked */
        .card.initiating {
            border-color: var(--cheer) !important;
            background: rgba(0, 255, 255, 0.1);
            pointer-events: none;
        }

        .card.initiating .detail {
            color: var(--cheer);
            font-weight: bold;
            letter-spacing: 1px;
        }

        /* Faster pulse for the initiation phase */
        .initiating-pulse {
            animation: rapid-pulse 0.4s infinite alternate;
        }

        @keyframes rapid-pulse {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0.7; transform: scale(0.97); }
        }

        .skip-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--skip-btn-bg);
            border: none;
            color: var(--text-primary);
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.15s ease;
            z-index: 5;
        }

        .card:hover .skip-btn {
            opacity: 1;
        }

        .skip-btn:hover {
            background: var(--skip-btn-hover-bg);
        }

        .drag-handle {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--drop-zone-text);
            font-size: 1rem;
            cursor: grab;
            user-select: none;
            opacity: 0;
            transition: opacity 0.15s ease;
        }

        .card:hover .drag-handle {
            opacity: 1;
            color: var(--text-secondary);
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        /* Configuration Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--overlay-bg);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: linear-gradient(135deg, rgba(13, 13, 18, 0.95), rgba(20, 20, 30, 0.95));
            border: 2px solid var(--sub);
            border-radius: 8px;
            padding: 20px;
            max-width: 280px;
            width: 90%;
            box-shadow: 0 0 30px var(--modal-glow);
        }

        .modal h2 {
            margin: 0 0 12px 0;
            font-size: 0.9rem;
            color: var(--accent);
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .modal p {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin: 0 0 15px 0;
            text-align: center;
            line-height: 1.4;
        }

        .modal label {
            display: block;
            font-size: 0.65rem;
            color: var(--cheer);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal select {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-primary);
            color-scheme: var(--color-scheme);
            font-size: 0.7rem;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .modal select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 10px rgba(255, 105, 180, 0.3);
        }

        .modal select option {
            background: var(--bg);
            color: var(--text-primary);
        }

        .modal-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .setup-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 14px;
        }

        .setup-tab {
            flex: 1;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-secondary);
            font-size: 0.62rem;
            padding: 8px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
            cursor: pointer;
        }

        .setup-tab.active {
            color: white;
            background: linear-gradient(135deg, rgba(147, 112, 219, 0.35), rgba(255, 105, 180, 0.35));
            border-color: var(--accent);
            box-shadow: 0 0 12px rgba(255, 105, 180, 0.25);
        }

        .setup-panel {
            display: none;
        }

        .setup-panel.active {
            display: block;
        }

        .setup-panel-footer {
            margin-top: 20px;
        }

        .visual-setting {
            margin-bottom: 12px;
        }

        .visual-setting label {
            display: block;
            font-size: 0.65rem;
            color: var(--cheer);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .visual-setting select {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-primary);
            color-scheme: var(--color-scheme);
            font-size: 0.7rem;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
        }

        .modal button {
            background: linear-gradient(135deg, var(--button-bg-start), var(--button-bg-end));
            border: 1px solid var(--input-border);
            color: var(--text-primary);
            font-size: 0.65rem;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
        }

        .modal button:hover {
            border-color: var(--sub);
            background: linear-gradient(135deg, rgba(147, 112, 219, 0.3), rgba(255, 105, 180, 0.3));
            box-shadow: 0 0 15px rgba(147, 112, 219, 0.4);
        }

        .modal button.primary {
            background: linear-gradient(135deg, var(--sub), var(--accent));
            border-color: var(--accent);
        }

        .modal button.primary:hover {
            box-shadow: 0 0 20px var(--focus-glow);
            transform: translateY(-1px);
        }

        .event-type-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--button-hover-start), var(--button-hover-end));
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin: 8px 0;
        }

        /* Control Bar Styles */
        .control-bar {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-top: 10px;
            padding: 6px;
            background: var(--panel-bg);
            border-radius: 6px;
            border: 1px solid var(--glass-border);
            position: relative;
            z-index: 100;
        }

        .control-bar select,
        .control-bar button {
            background: linear-gradient(135deg, var(--button-bg-start), var(--button-bg-end));
            border: 1px solid var(--input-border);
            color: var(--text-primary);
            color-scheme: var(--color-scheme);
            font-size: 0.6rem;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
            text-transform: uppercase;
            box-shadow: 0 0 10px rgba(147, 112, 219, 0);
        }

        .control-bar select {
            min-width: 95px;
            flex: 1;
        }

        .control-bar button {
            white-space: nowrap;
            flex-shrink: 0;
        }

        .control-bar select:hover,
        .control-bar button:hover {
            border-color: var(--sub);
            background: linear-gradient(135deg, rgba(147, 112, 219, 0.25), rgba(255, 105, 180, 0.25));
            box-shadow: 0 0 15px rgba(147, 112, 219, 0.4);
            transform: translateY(-1px);
        }

        .control-bar select:focus,
        .control-bar button:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(255, 105, 180, 0.5);
        }

        .control-bar button:active {
            transform: translateY(0);
            box-shadow: 0 0 10px var(--button-glow);
        }

        .control-bar select option,
        .modal select option,
        #setup-fields select option {
            background: var(--bg);
            color: var(--text-primary);
        }

        /* Neon glow effect for active states */
        .control-bar select:hover option,
        .control-bar select option:checked {
            background: var(--bg);
            color: var(--accent);
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>CATCH-UP</h1>
        <div id="stats">Connecting...</div>
    </div>
    
    <div id="container"></div>
    
    <!-- Configuration Modal -->
    <div id="config-modal" class="modal-overlay">
        <div class="modal">
            <h2>‚öôÔ∏è Setup Required</h2>
            <p id="modal-message">Please select an action for this event type:</p>
            <div class="event-type-badge" id="modal-event-type"></div>
            
            <label for="action-select">Choose Action:</label>
            <select id="action-select">
                <option value="">Loading actions...</option>
            </select>
            
            <div class="modal-buttons">
                <button id="modal-cancel">Cancel</button>
                <button id="modal-save" class="primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Setup All Modal -->
    <div id="setup-modal" class="modal-overlay">
        <div class="modal" style="max-width: 320px;">
            <h2>‚öôÔ∏è Celebration Setup</h2>
            <p style="font-size: 0.7rem; margin-bottom: 14px;">Configure actions and visuals for the dock:</p>

            <div class="setup-tabs">
                <button id="setup-tab-actions" class="setup-tab active">Action Setup</button>
                <button id="setup-tab-visuals" class="setup-tab">Visual Settings</button>
            </div>

            <div id="setup-panel-actions" class="setup-panel active">
                <div id="setup-fields"></div>

                <div class="modal-buttons setup-panel-footer">
                    <button id="setup-cancel-actions">Cancel</button>
                    <button id="setup-save-actions" class="primary">Save Actions</button>
                </div>
            </div>

            <div id="setup-panel-visuals" class="setup-panel">
                <div class="visual-setting">
                    <label for="visual-theme">Color Scheme</label>
                    <select id="visual-theme">
                        <option value="neon">Neon (Default)</option>
                        <option value="ocean">Ocean</option>
                        <option value="sunset">Sunset</option>
                        <option value="daylight">Daylight</option>
                        <option value="paper">Paper</option>
                    </select>
                </div>

                <div class="visual-setting">
                    <label for="visual-text-size">Text Size</label>
                    <select id="visual-text-size">
                        <option value="small">Small</option>
                        <option value="normal">Normal</option>
                        <option value="large">Large</option>
                    </select>
                </div>

                <div class="visual-setting">
                    <label for="visual-density">Card Density</label>
                    <select id="visual-density">
                        <option value="compact">Compact</option>
                        <option value="comfortable">Comfortable</option>
                        <option value="spacious">Spacious</option>
                    </select>
                </div>

                <div class="modal-buttons setup-panel-footer">
                    <button id="setup-cancel-visuals">Cancel</button>
                    <button id="setup-save-visuals" class="primary">Save Visuals</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="debug-log">Log: Initializing...</div>

    <script>

/* =========================================================
   LLAMA CATCH-UP DOCK
   Production Version (Server-Authoritative + Drag & Drop)
========================================================= */

const DOM = {
    container: document.getElementById('container'),
    stats: document.getElementById('stats'),
    debug: document.getElementById('debug-log'),
    header: document.getElementById('header'),
    modal: {
        overlay: document.getElementById('config-modal'),
        message: document.getElementById('modal-message'),
        eventType: document.getElementById('modal-event-type'),
        select: document.getElementById('action-select'),
        cancel: document.getElementById('modal-cancel'),
        save: document.getElementById('modal-save')
    },
    setup: {
        overlay: document.getElementById('setup-modal'),
        fields: document.getElementById('setup-fields'),
        tabActions: document.getElementById('setup-tab-actions'),
        tabVisuals: document.getElementById('setup-tab-visuals'),
        panelActions: document.getElementById('setup-panel-actions'),
        panelVisuals: document.getElementById('setup-panel-visuals'),
        cancelActions: document.getElementById('setup-cancel-actions'),
        saveActions: document.getElementById('setup-save-actions'),
        cancelVisuals: document.getElementById('setup-cancel-visuals'),
        saveVisuals: document.getElementById('setup-save-visuals'),
        theme: document.getElementById('visual-theme'),
        textSize: document.getElementById('visual-text-size'),
        density: document.getElementById('visual-density')
    }
};

const State = {
    client: null,
    pendingEvents: [],
    filter: "All",
    activeId: null,
    draggedElement: null,
    draggedId: null,
    dragPreview: null,
    availableActions: [],
    currentConfigType: null,
    currentConfigEvent: null,
    setupTab: 'actions',
    visualSettings: {
        theme: 'neon',
        textSize: 'normal',
        density: 'comfortable'
    }
};

const VISUAL_THEMES = {
    neon: {
        accent: '#ff69b4',
        sub: '#9370db',
        subBomb: '#ffff00',
        cheer: '#00ffff',
        bg: '#0d0d12',
        glass: 'rgba(255, 255, 255, 0.05)',
        glassBorder: 'rgba(255, 255, 255, 0.1)',
        textPrimary: '#ffffff',
        textSecondary: '#bbbbbb',
        textMuted: '#777777',
        panelBg: 'rgba(255, 255, 255, 0.02)',
        inputBg: 'rgba(255, 255, 255, 0.05)',
        inputBorder: 'rgba(147, 112, 219, 0.4)',
        overlayBg: 'rgba(0, 0, 0, 0.85)',
        colorScheme: 'dark'
    },
    ocean: {
        accent: '#54b4ff',
        sub: '#4f6cf0',
        subBomb: '#FAC16E',
        cheer: '#69FFD3',
        bg: '#005671',
        glass: 'rgba(75, 130, 180, 0.16)',
        glassBorder: 'rgba(125, 200, 255, 0.25)',
        textPrimary: '#eef8ff',
        textSecondary: '#bed7eb',
        textMuted: '#7fa2bf',
        panelBg: 'rgba(138, 187, 224, 0.15)',
        inputBg: 'rgba(129, 181, 219, 0.2)',
        inputBorder: 'rgba(125, 200, 255, 0.45)',
        overlayBg: 'rgba(2, 18, 34, 0.82)',
        colorScheme: 'dark'
    },
    sunset: {
        accent: '#ff8a5b',
        sub: '#ff477e',
        subBomb: '#ffd166',
        cheer: '#ffadad',
        bg: '#1a0f14',
        glass: 'rgba(255, 166, 128, 0.14)',
        glassBorder: 'rgba(255, 201, 158, 0.22)',
        textPrimary: '#fff4ee',
        textSecondary: '#f3cab8',
        textMuted: '#c48e79',
        panelBg: 'rgba(255, 166, 128, 0.09)',
        inputBg: 'rgba(255, 166, 128, 0.14)',
        inputBorder: 'rgba(255, 201, 158, 0.38)',
        overlayBg: 'rgba(28, 12, 16, 0.8)',
        colorScheme: 'dark'
    },
    daylight: {
        accent: '#da4d9a',
        sub: '#6f5be8',
        subBomb: '#d1a600',
        cheer: '#008eb5',
        bg: '#f5f8ff',
        glass: 'rgba(255, 255, 255, 0.85)',
        glassBorder: 'rgba(98, 121, 173, 0.25)',
        textPrimary: '#1f2a40',
        textSecondary: '#44506d',
        textMuted: '#687491',
        panelBg: 'rgba(227, 234, 247, 0.85)',
        inputBg: 'rgba(255, 255, 255, 0.95)',
        inputBorder: 'rgba(111, 91, 232, 0.35)',
        overlayBg: 'rgba(215, 225, 245, 0.78)',
        colorScheme: 'light'
    },
    paper: {
        accent: '#bd3a7e',
        sub: '#7254cf',
        subBomb: '#9b8400',
        cheer: '#0f8aa8',
        bg: '#fdf8f2',
        glass: 'rgba(255, 255, 255, 0.9)',
        glassBorder: 'rgba(145, 117, 90, 0.2)',
        textPrimary: '#2d261f',
        textSecondary: '#5d5143',
        textMuted: '#827462',
        panelBg: 'rgba(245, 235, 224, 0.82)',
        inputBg: 'rgba(255, 255, 255, 0.92)',
        inputBorder: 'rgba(114, 84, 207, 0.3)',
        overlayBg: 'rgba(236, 225, 213, 0.76)',
        colorScheme: 'light'
    }
};

const TEXT_SIZE_MAP = {
    small: '14px',
    normal: '16px',
    large: '18px'
};

const CARD_DENSITY_MAP = {
    compact: '7px',
    comfortable: '10px',
    spacious: '13px'
};

function createDragPreview(card) {
    const preview = card.cloneNode(true);
    preview.classList.remove('dragging', 'drag-over', 'active-celebration', 'initiating', 'initiating-pulse');
    preview.classList.add('drag-preview');

    const skipBtn = preview.querySelector('.skip-btn');
    if (skipBtn) skipBtn.remove();

    const dragHandle = preview.querySelector('.drag-handle');
    if (dragHandle) dragHandle.style.opacity = '0.8';

    const { width } = card.getBoundingClientRect();
    preview.style.width = `${Math.max(220, width)}px`;
    preview.style.position = 'fixed';
    preview.style.top = '-1000px';
    preview.style.left = '-1000px';
    preview.style.pointerEvents = 'none';

    document.body.appendChild(preview);
    State.dragPreview = preview;

    return preview;
}

function cleanupDragPreview() {
    if (State.dragPreview) {
        State.dragPreview.remove();
        State.dragPreview = null;
    }
}

/* =========================================================
   LOGGER
========================================================= */
function log(message) {
    DOM.debug.innerText = `Log: ${message}`;
    console.log("[LlamaCatchup]", message);
}

/* =========================================================
   INITIALIZATION
========================================================= */
function initApp() {
    buildControlBar();
    initializeStreamerbotClient();
    setupModal();
    applyVisualSettings();
}

/* =========================================================
   MODAL SETUP
========================================================= */
function setupModal() {
    const switchSetupTab = (tabName) => {
        State.setupTab = tabName;
        const isActions = tabName === 'actions';

        DOM.setup.tabActions.classList.toggle('active', isActions);
        DOM.setup.tabVisuals.classList.toggle('active', !isActions);
        DOM.setup.panelActions.classList.toggle('active', isActions);
        DOM.setup.panelVisuals.classList.toggle('active', !isActions);
    };

    DOM.setup.tabActions.onclick = () => switchSetupTab('actions');
    DOM.setup.tabVisuals.onclick = () => switchSetupTab('visuals');

    DOM.modal.cancel.onclick = () => {
        DOM.modal.overlay.classList.remove('visible');
        State.currentConfigType = null;
        State.currentConfigEvent = null;
    };

    DOM.modal.save.onclick = async () => {
        const selectedAction = DOM.modal.select.value;
        if (!selectedAction || !State.currentConfigType) return;

        const varName = getGlobalVarName(State.currentConfigType);
        
        log(`=== SAVE DEBUG ===`);
        log(`Selected from dropdown: "${selectedAction}"`);
        log(`Variable name: "${varName}"`);
        log(`Event type: "${State.currentConfigType}"`);
        
        try {
            // Call a C# action to save the global variable
            // NOTE: We use 'celebrationAction' instead of 'actionName' 
            // because Streamerbot auto-adds 'actionName' with the action being called
            const result = await State.client.doAction(
                { name: "SaveCelebrationConfig" },
                {
                    varName: varName,
                    celebrationAction: selectedAction
                }
            );
            
            log(`doAction response: ${JSON.stringify(result)}`);
            log(`Saved ${varName} = ${selectedAction}`);
            DOM.modal.overlay.classList.remove('visible');
            
            // Retry the celebration if we have the event
            if (State.currentConfigEvent && State.currentConfigEvent.Id) {
                const eventId = State.currentConfigEvent.Id;
                setTimeout(() => {
                    const card = document.querySelector(`[data-id="${eventId}"]`);
                    if (card) {
                        const event = State.pendingEvents.find(e => e.Id === eventId);
                        if (event) {
                            handleCelebration(card, event);
                        } else {
                            log(`Event ${eventId} no longer in pending list`);
                        }
                    } else {
                        log(`Card for event ${eventId} not found`);
                    }
                }, 500);
            }
            
            State.currentConfigType = null;
            State.currentConfigEvent = null;
        } catch (err) {
            log(`Error saving config: ${err.message}`);
        }
    };

    // Setup modal handlers
    DOM.setup.cancelActions.onclick = () => {
        DOM.setup.overlay.classList.remove('visible');
    };

    DOM.setup.saveActions.onclick = async () => {
        const configs = [
            { type: 'NewSub', select: 'setup-newsub' },
            { type: 'Resub', select: 'setup-resub' },
            { type: 'GiftSub', select: 'setup-giftsub' },
            { type: 'SubBomb', select: 'setup-subbomb' },
            { type: 'Cheer', select: 'setup-cheer' }
        ];

        try {
            for (const config of configs) {
                const select = document.getElementById(config.select);
                const selectedAction = select?.value;
                
                if (selectedAction && selectedAction !== '') {
                    const varName = getGlobalVarName(config.type);
                    await State.client.doAction(
                        { name: "SaveCelebrationConfig" },
                        {
                            varName: varName,
                            celebrationAction: selectedAction
                        }
                    );
                    log(`Configured ${config.type}: ${selectedAction}`);
                }
            }
            
            log('Setup complete!');
            DOM.setup.overlay.classList.remove('visible');
        } catch (err) {
            log(`Error during setup: ${err.message}`);
        }
    };

    DOM.setup.cancelVisuals.onclick = () => {
        DOM.setup.overlay.classList.remove('visible');
    };

    DOM.setup.saveVisuals.onclick = async () => {
        State.visualSettings = {
            theme: DOM.setup.theme.value,
            textSize: DOM.setup.textSize.value,
            density: DOM.setup.density.value
        };

        try {
            await persistVisualSettings();
            applyVisualSettings();
            DOM.setup.overlay.classList.remove('visible');
            log('Visual settings saved');
        } catch (err) {
            log(`Failed to save visual settings: ${err.message}`);
        }
    };

}

function normalizeVisualSettings(settings) {
    return {
        theme: VISUAL_THEMES[settings.theme] ? settings.theme : 'neon',
        textSize: TEXT_SIZE_MAP[settings.textSize] ? settings.textSize : 'normal',
        density: CARD_DENSITY_MAP[settings.density] ? settings.density : 'comfortable'
    };
}

async function loadVisualSettings() {
    if (!State.client) return;

    const fallback = normalizeVisualSettings(State.visualSettings);

    await State.client.doAction(
        { name: "SaveCelebrationConfig" },
        {
            operation: 'visuals',
            mode: 'ensure',
            theme: fallback.theme,
            textSize: fallback.textSize,
            density: fallback.density
        }
    );

    const [themeResponse, textSizeResponse, densityResponse] = await Promise.all([
        State.client.getGlobal('catchupVisualTheme', true),
        State.client.getGlobal('catchupVisualTextSize', true),
        State.client.getGlobal('catchupVisualDensity', true)
    ]);

    State.visualSettings = normalizeVisualSettings({
        theme: themeResponse?.variable?.value || fallback.theme,
        textSize: textSizeResponse?.variable?.value || fallback.textSize,
        density: densityResponse?.variable?.value || fallback.density
    });
}

async function persistVisualSettings() {
    const sanitized = normalizeVisualSettings(State.visualSettings);
    State.visualSettings = sanitized;

    await State.client.doAction(
        { name: "SaveCelebrationConfig" },
        {
            operation: 'visuals',
            mode: 'save',
            theme: sanitized.theme,
            textSize: sanitized.textSize,
            density: sanitized.density
        }
    );
}

function applyVisualSettings() {
    const root = document.documentElement;
    const theme = VISUAL_THEMES[State.visualSettings.theme] || VISUAL_THEMES.neon;
    const textSize = TEXT_SIZE_MAP[State.visualSettings.textSize] || TEXT_SIZE_MAP.normal;
    const cardPadding = CARD_DENSITY_MAP[State.visualSettings.density] || CARD_DENSITY_MAP.comfortable;

    root.style.setProperty('--accent', theme.accent);
    root.style.setProperty('--sub', theme.sub);
    root.style.setProperty('--sub-bomb', theme.subBomb);
    root.style.setProperty('--cheer', theme.cheer);
    root.style.setProperty('--bg', theme.bg);
    root.style.setProperty('--glass', theme.glass);
    root.style.setProperty('--glass-border', theme.glassBorder);
    root.style.setProperty('--text-primary', theme.textPrimary || '#ffffff');
    root.style.setProperty('--text-secondary', theme.textSecondary || '#bbbbbb');
    root.style.setProperty('--text-muted', theme.textMuted || '#777777');
    root.style.setProperty('--panel-bg', theme.panelBg || 'rgba(255, 255, 255, 0.02)');
    root.style.setProperty('--input-bg', theme.inputBg || 'rgba(255, 255, 255, 0.05)');
    root.style.setProperty('--input-border', theme.inputBorder || 'rgba(147, 112, 219, 0.4)');
    root.style.setProperty('--overlay-bg', theme.overlayBg || 'rgba(0, 0, 0, 0.85)');
    root.style.setProperty('--color-scheme', theme.colorScheme || 'dark');

    const isLightTheme = (theme.colorScheme || 'dark') === 'light';
    root.style.setProperty('--debug-text', isLightTheme ? '#6e778d' : '#5c5c66');
    root.style.setProperty('--debug-border', isLightTheme ? '#b6bfd4' : '#2a2a33');
    root.style.setProperty('--drop-zone-border', isLightTheme ? 'rgba(89, 104, 136, 0.35)' : 'rgba(255, 255, 255, 0.1)');
    root.style.setProperty('--drop-zone-text', isLightTheme ? 'rgba(68, 80, 109, 0.7)' : 'rgba(255, 255, 255, 0.3)');
    root.style.setProperty('--drop-zone-active-bg', isLightTheme ? 'rgba(0, 142, 181, 0.12)' : 'rgba(0, 255, 255, 0.05)');
    root.style.setProperty('--card-hover-bg', isLightTheme ? 'rgba(255, 255, 255, 0.95)' : 'rgba(255, 255, 255, 0.08)');
    root.style.setProperty('--drag-preview-shadow', isLightTheme
        ? '0 10px 24px rgba(31, 42, 64, 0.2), 0 0 0 1px rgba(98, 121, 173, 0.28) inset'
        : '0 12px 30px rgba(0, 0, 0, 0.45), 0 0 0 1px rgba(255, 255, 255, 0.12) inset');
    root.style.setProperty('--sub-bomb-glow', isLightTheme ? 'rgba(209, 166, 0, 0.28)' : 'rgba(255, 255, 0, 0.3)');
    root.style.setProperty('--cheer-glow', isLightTheme ? 'rgba(0, 142, 181, 0.28)' : 'rgba(0, 255, 255, 0.3)');
    root.style.setProperty('--cheer-soft-bg', isLightTheme ? 'rgba(0, 142, 181, 0.14)' : 'rgba(0, 255, 255, 0.1)');
    root.style.setProperty('--modal-bg-start', isLightTheme ? 'rgba(255, 255, 255, 0.97)' : 'rgba(13, 13, 18, 0.95)');
    root.style.setProperty('--modal-bg-end', isLightTheme ? 'rgba(240, 245, 255, 0.95)' : 'rgba(20, 20, 30, 0.95)');
    root.style.setProperty('--modal-glow', isLightTheme ? 'rgba(111, 91, 232, 0.25)' : 'rgba(147, 112, 219, 0.5)');
    root.style.setProperty('--button-bg-start', isLightTheme ? 'rgba(111, 91, 232, 0.16)' : 'rgba(147, 112, 219, 0.2)');
    root.style.setProperty('--button-bg-end', isLightTheme ? 'rgba(218, 77, 154, 0.16)' : 'rgba(255, 105, 180, 0.2)');
    root.style.setProperty('--button-hover-start', isLightTheme ? 'rgba(111, 91, 232, 0.24)' : 'rgba(147, 112, 219, 0.3)');
    root.style.setProperty('--button-hover-end', isLightTheme ? 'rgba(218, 77, 154, 0.24)' : 'rgba(255, 105, 180, 0.3)');
    root.style.setProperty('--button-glow', isLightTheme ? 'rgba(111, 91, 232, 0.28)' : 'rgba(147, 112, 219, 0.4)');
    root.style.setProperty('--focus-glow', isLightTheme ? 'rgba(218, 77, 154, 0.35)' : 'rgba(255, 105, 180, 0.5)');
    root.style.setProperty('--tab-active-start', isLightTheme ? 'rgba(111, 91, 232, 0.22)' : 'rgba(147, 112, 219, 0.35)');
    root.style.setProperty('--tab-active-end', isLightTheme ? 'rgba(218, 77, 154, 0.22)' : 'rgba(255, 105, 180, 0.35)');
    root.style.setProperty('--tab-active-glow', isLightTheme ? 'rgba(218, 77, 154, 0.28)' : 'rgba(255, 105, 180, 0.25)');

    root.style.setProperty('--card-padding', cardPadding);
    root.style.fontSize = textSize;
}

async function showSetupModal() {
    // Ensure actions are loaded
    if (State.availableActions.length === 0) {
        await loadActions();
    }

    // Filter out system actions
    const systemActions = [
        'SaveCelebrationConfig',
        'CelebrationManager',
        'StoreEvent',
        'HandleSingleGift'
    ];

    const celebrationActions = State.availableActions.filter(action => 
        !systemActions.includes(action.name)
    );

    // Get current config values
    const eventTypes = [
        { type: 'NewSub', label: 'New Subscription', icon: 'üíú', varName: 'newSubAction' },
        { type: 'Resub', label: 'Resubscription', icon: 'üîÑ', varName: 'resubAction' },
        { type: 'GiftSub', label: 'Gifted Sub', icon: 'üéÅ', varName: 'giftSubAction' },
        { type: 'SubBomb', label: 'Sub Bomb', icon: 'üí£', varName: 'subBombAction' },
        { type: 'Cheer', label: 'Cheer / Bits', icon: 'üíé', varName: 'cheerAction' }
    ];

    // Load current values from global variables
    const currentValues = {};
    try {
        for (const eventType of eventTypes) {
            const result = await State.client.getGlobal(eventType.varName, true);
            currentValues[eventType.varName] = result?.variable?.value || '';
            log(`Current ${eventType.varName}: ${currentValues[eventType.varName]}`);
        }
    } catch (err) {
        log(`Error loading current config: ${err.message}`);
    }

    // Build fields
    DOM.setup.fields.innerHTML = '';
    DOM.setup.theme.value = State.visualSettings.theme;
    DOM.setup.textSize.value = State.visualSettings.textSize;
    DOM.setup.density.value = State.visualSettings.density;
    
    for (const eventType of eventTypes) {
        const field = document.createElement('div');
        field.style.marginBottom = '15px';
        
        const label = document.createElement('label');
        label.style.display = 'block';
        label.style.fontSize = '0.65rem';
        label.style.color = 'var(--cheer)';
        label.style.marginBottom = '6px';
        label.style.textTransform = 'uppercase';
        label.textContent = `${eventType.icon} ${eventType.label}`;
        
        const select = document.createElement('select');
        select.id = `setup-${eventType.type.toLowerCase()}`;
        select.style.width = '100%';
        select.style.background = 'var(--input-bg)';
        select.style.border = '1px solid var(--input-border)';
        select.style.color = 'var(--text-primary)';
        select.style.colorScheme = 'var(--color-scheme)';
        select.style.fontSize = '0.7rem';
        select.style.padding = '8px';
        select.style.borderRadius = '4px';
        select.style.cursor = 'pointer';
        
        // Add empty option
        const emptyOption = document.createElement('option');
        emptyOption.value = '';
        emptyOption.textContent = '-- Not Configured --';
        select.appendChild(emptyOption);
        
        // Add all celebration actions
        celebrationActions.forEach(action => {
            const option = document.createElement('option');
            option.value = action.name;
            option.textContent = action.name;
            select.appendChild(option);
        });
        
        // Set current value if it exists
        const currentValue = currentValues[eventType.varName];
        if (currentValue) {
            select.value = currentValue;
            // Highlight that this is already configured
            label.innerHTML = `${eventType.icon} ${eventType.label} <span style="color: var(--accent); font-size: 0.6rem;">‚úì CONFIGURED</span>`;
        }
        
        field.appendChild(label);
        field.appendChild(select);
        DOM.setup.fields.appendChild(field);
    }

    DOM.setup.tabActions.click();
    DOM.setup.overlay.classList.add('visible');
}

async function loadActions() {
    try {
        const result = await State.client.getActions();
        State.availableActions = result.actions || [];
        // Silently loaded - only log if there's an issue
    } catch (err) {
        log(`Error loading actions: ${err.message}`);
        State.availableActions = [];
    }
}

function getGlobalVarName(eventType) {
    const typeMap = {
        'NewSub': 'newSubAction',
        'Resub': 'resubAction',
        'GiftSub': 'giftSubAction',
        'SubBomb': 'subBombAction',
        'Cheer': 'cheerAction'
    };
    return typeMap[eventType] || 'unknownAction';
}

function getEventTypeDisplay(eventType) {
    const typeMap = {
        'NewSub': 'New Subscription',
        'Resub': 'Resubscription',
        'GiftSub': 'Gifted Sub',
        'SubBomb': 'Sub Bomb',
        'Cheer': 'Cheer / Bits'
    };
    return typeMap[eventType] || eventType;
}

async function showConfigModal(eventType, event) {
    log(`showConfigModal called: ${eventType}`);
    State.currentConfigType = eventType;
    State.currentConfigEvent = event;

    // Ensure actions are loaded
    if (State.availableActions.length === 0) {
        log('Loading actions...');
        await loadActions();
    }

    log(`Available actions: ${State.availableActions.length}`);

    // Filter out system/helper actions from the dropdown
    const systemActions = [
        'SaveCelebrationConfig',
        'CelebrationManager',
        'CelebrationAlert',  // Old action, kept for compatibility
        'StoreEvent',
        'SkipCelebration',   // Old action, kept for compatibility
        'SortCelebrations',  // Old action, kept for compatibility
        'HandleSingleGift',
        'TestConfigEvent'
    ];

    const celebrationActions = State.availableActions.filter(action => 
        !systemActions.includes(action.name)
    );

    // Populate dropdown with filtered actions
    DOM.modal.select.innerHTML = '<option value="">-- Select Action --</option>';
    celebrationActions.forEach(action => {
        const option = document.createElement('option');
        option.value = action.name;
        option.textContent = action.name;
        DOM.modal.select.appendChild(option);
    });

    log(`Filtered to ${celebrationActions.length} celebration actions`);

    // Update modal content
    DOM.modal.eventType.textContent = getEventTypeDisplay(eventType);
    DOM.modal.message.textContent = `No action configured for ${getEventTypeDisplay(eventType)}. Please select an action:`;

    log('Showing modal...');
    // Show modal
    DOM.modal.overlay.classList.add('visible');
    log('Modal visible class added');
}

/* =========================================================
   CONTROL BAR
========================================================= */
function buildControlBar() {

    const bar = document.createElement("div");
    bar.className = "control-bar";

    const filterSelect = document.createElement("select");
    filterSelect.title = "Filter events by type";

    ["All", "Sub", "Cheer", "SubBomb"].forEach(type => {
        const option = document.createElement("option");
        option.value = type;
        option.text = type === "All" ? "üéØ All" : 
                      type === "Sub" ? "üíú Subs" :
                      type === "Cheer" ? "üíé Bits" :
                      "üéÅ Bombs";
        filterSelect.appendChild(option);
    });

    filterSelect.onchange = (e) => {
        State.filter = e.target.value;
        render();
    };

    bar.appendChild(filterSelect);

    const sortBtn = document.createElement("button");
    sortBtn.innerHTML = "SORT BY ‚è∞";
    sortBtn.title = "Sort events chronologically";
    sortBtn.onclick = triggerServerSort;

    bar.appendChild(sortBtn);

    const setupBtn = document.createElement("button");
    setupBtn.innerHTML = "‚öôÔ∏è SETUP";
    setupBtn.title = "Configure all celebration actions";
    setupBtn.onclick = showSetupModal;
    setupBtn.style.fontSize = "0.55rem";
    bar.appendChild(setupBtn);

    DOM.header.appendChild(bar);
}

/* =========================================================
   STREAMER.BOT CONNECTION
========================================================= */
function initializeStreamerbotClient() {

    State.client = new StreamerbotClient({
        host: '127.0.0.1',
        port: 8080,
        immediate: true,
        storage: null,
        onConnect: handleConnection,
        subscribe: {
            'Misc': ['GlobalVariableUpdated'],
            'Custom': ['Event']
        }
    });

    State.client.on('Misc.GlobalVariableUpdated', ({ data }) => {
        if (data.name === 'pendingCelebrations')
            processRawData(data.newValue);
    });

    // Listen for Custom.Event and check if it's our CelebrationConfigNeeded
    State.client.on('Custom.Event', (event) => {
        if (event.data?.eventName === 'CelebrationConfigNeeded') {
            log(`CelebrationConfigNeeded event detected`);
            handleConfigNeeded(event);
        }
    });
}

function handleConfigNeeded(event) {
    // The args are in event.data.args
    const args = event.data?.args || {};
    
    log(`handleConfigNeeded - eventType: ${args.eventType}, eventId: ${args.eventId}`);
    
    const eventId = args.eventId;
    const eventType = args.eventType;
    
    if (eventId && eventType) {
        log(`Config needed for ${eventType}, event ID: ${eventId}`);
        const pendingEvent = State.pendingEvents.find(e => e.Id === eventId);
        if (pendingEvent) {
            showConfigModal(eventType, pendingEvent);
        } else {
            log(`Event not found in pending list: ${eventId}`);
            // Still show modal but without retry capability
            showConfigModal(eventType, { Id: eventId, User: args.user, Detail: args.detail });
        }
    } else {
        log(`Missing eventId or eventType in args`);
    }
}

async function handleConnection() {
    DOM.stats.innerText = "Connected";
    await loadVisualSettings();
    applyVisualSettings();
    fetchEvents();
    loadActions();
}

async function fetchEvents() {
    const response = await State.client.getGlobal("pendingCelebrations", true);
    processRawData(response?.variable?.value || "[]");
}

function processRawData(raw) {
    const parsed = typeof raw === "string" ? JSON.parse(raw) : raw;
    State.pendingEvents = parsed || [];
    render();
}

/* =========================================================
   RENDERING
========================================================= */
function render() {
    DOM.stats.innerText = `${State.pendingEvents.length} Pending Alerts`;

    const filtered = State.filter === "All"
        ? State.pendingEvents
        : State.pendingEvents.filter(e => e.Type === State.filter);

    if (!filtered.length) {
        DOM.container.innerHTML =
            '<p style="text-align:center; opacity:0.3; margin-top:20px; font-size:0.8rem;">All caught up! ü¶ô</p>';
        return;
    }

    DOM.container.innerHTML = '';

    filtered.forEach(event => {
        const card = createCard(event);
        DOM.container.appendChild(card);
    });

    // Add bottom drop zone
    const dropZone = document.createElement('div');
    dropZone.id = 'drop-zone-bottom';
    dropZone.innerHTML = 'Drop here to move to bottom';
    attachBottomDropZoneHandlers(dropZone);
    DOM.container.appendChild(dropZone);
}

function createCard(event) {

    const card = document.createElement("div");
    card.className = `card ${event.Type || "Event"}`;
    card.dataset.id = event.Id;

    if (event.Id === State.activeId)
        card.style.border = "2px solid cyan";

    card.innerHTML = `
        <span class="drag-handle" draggable="true">‚ãÆ‚ãÆ</span>
        <span class="time">${event.Timestamp}</span>
        <span class="user" style="margin-left: 24px;">${event.User}</span>
        <span class="detail" style="margin-left: 24px;">${event.Detail}</span>
        <button class="skip-btn">Skip</button>
    `;

    attachHandlers(card, event);
    attachDragHandlers(card);
    return card;
}

/* =========================================================
   BOTTOM DROP ZONE HANDLERS
========================================================= */
function attachBottomDropZoneHandlers(dropZone) {
    
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', (e) => {
        dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', async (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');

        if (!State.draggedId) return;

        // Get the last card in the filtered list
        const cards = Array.from(document.querySelectorAll('.card'));
        const lastCard = cards[cards.length - 1];
        
        if (!lastCard || State.draggedId === lastCard.dataset.id) {
            return; // Already at bottom
        }

        const targetId = lastCard.dataset.id;
        
        log(`Drop to bottom: ${State.draggedId} ‚Üí after ${targetId}`);

        try {
            await State.client.doAction(
                { name: "CelebrationManager" },
                {
                    operation: "sort",
                    draggedId: State.draggedId,
                    targetId: targetId,
                    insertAfter: true
                }
            );
            log('Reorder complete');
        } catch (err) {
            log(`Error: ${err.message}`);
        }
    });
}

/* =========================================================
   CELEBRATION
========================================================= */
function attachHandlers(card, event) {

    const skipBtn = card.querySelector(".skip-btn");

    // Only trigger celebration when clicking on the card content (not drag handle or skip)
    card.addEventListener('click', (e) => {
        if (e.target.classList.contains('skip-btn') || 
            e.target.classList.contains('drag-handle')) {
            return;
        }
        handleCelebration(card, event);
    });

    skipBtn.onclick = (e) => handleSkip(e, event);
}

/* =========================================================
   DRAG & DROP HANDLERS
========================================================= */
function attachDragHandlers(card) {

    const dragHandle = card.querySelector('.drag-handle');

    dragHandle.addEventListener('dragstart', (e) => {
        State.draggedElement = card;
        State.draggedId = card.dataset.id;
        card.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';

        cleanupDragPreview();
        const preview = createDragPreview(card);
        e.dataTransfer.setDragImage(preview, 24, 20);
        
        // Show bottom drop zone
        const dropZone = document.getElementById('drop-zone-bottom');
        if (dropZone) dropZone.classList.add('visible');
        
        log(`Dragging: ${State.draggedId}`);
    });

    dragHandle.addEventListener('dragend', (e) => {
        card.classList.remove('dragging');
        State.draggedElement = null;
        State.draggedId = null;
        cleanupDragPreview();
        
        // Remove drag-over class from all cards and hide drop zone
        document.querySelectorAll('.card').forEach(c => {
            c.classList.remove('drag-over');
        });
        
        const dropZone = document.getElementById('drop-zone-bottom');
        if (dropZone) {
            dropZone.classList.remove('visible', 'drag-over');
        }
    });

    card.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        
        if (State.draggedElement && State.draggedElement !== card) {
            card.classList.add('drag-over');
        }
    });

    card.addEventListener('dragleave', (e) => {
        card.classList.remove('drag-over');
    });

    card.addEventListener('drop', async (e) => {
        e.preventDefault();
        card.classList.remove('drag-over');

        if (!State.draggedId || State.draggedId === card.dataset.id) {
            return;
        }

        const targetId = card.dataset.id;
        
        log(`Drop: ${State.draggedId} ‚Üí ${targetId}`);

        try {
            await State.client.doAction(
                { name: "CelebrationManager" },
                {
                    operation: "sort",
                    draggedId: State.draggedId,
                    targetId: targetId
                }
            );
            log('Reorder complete');
        } catch (err) {
            log(`Error: ${err.message}`);
        }
    });
}

function handleCelebration(card, event) {

    State.activeId = event.Id;
    
    card.classList.add("initiating", "initiating-pulse");
    const detailSpan = card.querySelector(".detail");
    if (detailSpan) {
        detailSpan.innerText = "‚ú® INITIATING CELEBRATION...";
    }

    setTimeout(async () => {
        try {
            await State.client.doAction(
                { name: "CelebrationManager" },
                { 
                    operation: "alert",
                    eventId: event.Id 
                }
            );
        } finally {
            State.activeId = null;
        }
    }, 1500);
}

/* =========================================================
   SKIP
========================================================= */
async function handleSkip(e, event) {

    e.stopPropagation();

    if (!confirm(`Skip ${event.User}'s ${event.Type}?`)) return;

    await State.client.doAction(
        { name: "CelebrationManager" },
        { 
            operation: "skip",
            eventId: event.Id 
        }
    );
}

/* =========================================================
   SERVER SORT
========================================================= */
async function triggerServerSort() {
    await State.client.doAction(
        { name: "CelebrationManager" },
        { operation: "sort" }
    );
}

/* =========================================================
   START
========================================================= */
initApp();

</script>


</body>
</html>
